name: dev-setup
version: 2020-02-28

parameters:
  - name: username
    description: The system username
    type: string
    short: '-uUSERNAME'
    long: '--username=USERNAME'
    required: true

actions:
  - description: Create a Vim Init File
    flag: vimrc
    type: file
    content: |
      syntax on
      autocmd Filetype gitcommit setlocal spell textwidth=72
    path: ~/.vimrc
    permissions: 0644

  - description: Install Homebrew
    flag: homebrew-install
    type: shell
    up: /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    down: /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/uninstall)"
    test: which brew

  - description: Create a Source Directory
    flag: srcdirectory
    type: shell
    up: mkdir ~/src
    down: rm -rf ~/src
    test: "file ~/src | grep 'src: directory'"

  - description: Generate Base Brewfile
    flag: brewfile-base
    type: file
    content: |
      brew "git"
      brew "gnupg"
      brew "redis"
      brew "python3"
      brew "pipenv"
      brew "cookiecutter"
      brew "rbenv"
      brew "postgresql"
      brew "node"
      brew "yarn"
      brew "nvm"
      brew "flow"
      brew "watchman"
      brew "awscli"
      brew "aws-sam-cli"
      brew "terraform"
      brew "ansible"
      cask "clipy"
      cask "coconutbattery"
      cask "visual-studio-code"
      cask "react-native-debugger"
      cask "gitify"
      cask "docker"
      cask "postman"
      cask "iterm2"
    path: '~/src/Brewfile'
    permissions: 0644

  - description: Install Homebrew Dependencies
    flag: homebrew-dependencies
    type: shell
    up: brew bundle install --file=/Users/${parameters:username}/src/Brewfile
    down: brew bundle cleanup --file=/Users/${parameters:username}/src/Brewfile
    test: brew bundle check --file=/Users/${parameters:username}/src/Brewfile

  - description: Enable Homebrew Services
    flag: homebrew-services
    type: shell
    up: >
      brew services start redis;
      brew services start postgresql;
    down: >
      brew services stop redis;
      brew services stop postgresql;
    test: >
      brew services list | grep redis | awk '{print $2}' | grep started &&
      brew services list | grep postgresql | awk '{print $2}' | grep started

  - description: Install Oh My Zsh
    flag: ohmyzsh
    type: shell
    up: sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
    down: sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/uninstall.sh)"
    test: "file ~/.oh-my-zsh | grep 'oh-my-zsh: directory'"
  # NOTE: The following action may error until android stuido has been opened and installation
  # has been completed